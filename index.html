<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, viewport-fit=cover">
    <title>绝代双骄:终焉未至 荣耀礼盒</title>
    <style>
        html, body {
            touch-action: manipulation;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        @media (hover: none) {
            * {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
            }
        }

        :root {
            --gold: #FFD700;
            --orange: #FFA500;
            --dark-gold: #daa520;
        }

        body {
            position: relative;
            color: white;
            font-family: '微软雅黑', sans-serif;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            background: #0a0a0a url('https://cdn.jsdelivr.net/gh/Kybzl/Pictures@main/images/PDP.jpg') no-repeat center/cover fixed;
            display: flex;
            flex-direction: column;
        }

        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            position: relative;
            flex: 1;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .card {
            background: linear-gradient(45deg, rgba(255,215,0,0.1), rgba(0,0,0,0.3));
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid var(--gold);
            box-shadow: 0 0 30px rgba(255,215,0,0.2);
            position: relative;
        }

        .draw-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(45deg, var(--gold), var(--orange));
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            color: #1a1a1a;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255,215,0,0.4);
        }

        .draw-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,215,0,0.6);
        }

        .draw-button:active {
            transform: translateY(1px);
        }

        .collapse-button {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--gold);
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            margin: 10px 0;
            transition: all 0.3s;
        }

        .collapse-button:hover {
            background: rgba(255,255,255,0.2);
        }

        .collapsed {
            display: none;
        }

        .rewards-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .shop-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .shop-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            width: 220px;
            transition: transform 0.3s;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .shop-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255,215,0,0.3);
        }

        .player-image {
            width: 50%;
            max-width: 100px;
            height: auto;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid var(--gold);
            box-shadow: 0 0 15px rgba(255,215,0,0.3);
            transition: transform 0.3s;
        }

        .shop-item button {
            background: linear-gradient(45deg, var(--gold), var(--orange));
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            color: #1a1a1a;
            margin-top: 10px;
            transition: transform 0.2s;
            cursor: pointer;
            font-weight: bold;
        }

        .shop-item button:hover {
            transform: scale(1.05);
        }

        .reward-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin: 10px;
            border-radius: 10px;
            transition: transform 0.3s;
        }

        .open-button {
            background: linear-gradient(45deg, #00FF88, #00CC66);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            color: #1a1a1a;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .open-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0,255,136,0.5);
        }

        .reward-badge {
            font-size: 0.8em;
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        /* 免责声明弹窗 */
        .disclaimer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.5s ease;
        }
        
        .disclaimer-content {
            background: linear-gradient(145deg, rgba(20,20,20,0.95), rgba(40,40,40,0.95));
            border: 3px solid var(--gold);
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 0 50px rgba(255,215,0,0.5);
            animation: scaleIn 0.5s ease;
        }
        
        .disclaimer-content h2 {
            color: var(--gold);
            margin-bottom: 20px;
            font-size: 2rem;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        
        .disclaimer-content p {
            margin: 15px 0;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .disclaimer-button {
            background: linear-gradient(45deg, var(--gold), var(--orange));
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            color: #1a1a1a;
            font-weight: bold;
            margin-top: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(255,215,0,0.4);
        }
        
        .disclaimer-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255,215,0,0.6);
        }
        
        /* 历史记录 */
        .history-container {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 10px;
            padding: 15px;
            background: rgba(0,0,0,0.5);
        }
        
        .history-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-player {
            color: var(--gold);
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255,215,0,0.5);
        }
        
        /* 自选弹窗 */
        .selection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .selection-content {
            background: linear-gradient(145deg, rgba(20,20,20,0.95), rgba(40,40,40,0.95));
            border: 3px solid var(--gold);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 0 50px rgba(255,215,0,0.5);
        }
        
        .selection-content h2 {
            color: var(--gold);
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        
        .player-option {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 15px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        
        .player-option:hover {
            background: rgba(255,215,0,0.2);
            border: 1px solid var(--gold);
            transform: translateY(-3px);
        }
        
        .player-option img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            margin-right: 20px;
            border: 2px solid var(--gold);
            box-shadow: 0 0 10px rgba(255,215,0,0.3);
        }
        
        .player-option span {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--gold);
        }
        
        /* 页脚 */
        .footer {
            text-align: center;
            padding: 25px;
            margin-top: 40px;
            color: var(--gold);
            font-size: 1.1rem;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255,215,0,0.7);
            background: rgba(0,0,0,0.7);
            border-top: 2px solid var(--gold);
        }
        
        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .status-bar {
                grid-template-columns: 1fr;
            }
            
            .draw-button {
                position: relative;
                bottom: auto;
                right: auto;
                width: 100%;
                margin-top: 20px;
            }
            
            .shop-row {
                flex-direction: column;
                align-items: center;
            }
            
            .shop-item {
                width: 100%;
                max-width: 280px;
                margin: 10px 0;
            }
            
            .disclaimer-content {
                padding: 20px;
            }
            
            .disclaimer-content h2 {
                font-size: 1.5rem;
            }
            
            .selection-content {
                padding: 20px;
            }
            
            .player-option {
                flex-direction: column;
                text-align: center;
            }
            
            .player-option img {
                margin-right: 0;
                margin-bottom: 10px;
            }
        }

        @media (max-width: 480px) {
            .shop-item {
                width: 100%;
                margin: 10px 0;
            }
            
            .draw-button {
                padding: 12px 24px;
                font-size: 14px;
            }
            
            .disclaimer-button {
                padding: 10px 20px;
                font-size: 1rem;
            }
            
            .footer {
                font-size: 1rem;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- 免责声明弹窗 -->
    <div class="disclaimer-modal" id="disclaimerModal">
        <div class="disclaimer-content">
            <h2>免责声明</h2>
            <p>免费模拟器，仅供娱乐，禁止商用，若有违法行为后果自负！</p>
            <p>作者: 大众评球@不出维埃拉不改名（已兑换）</p>
            <button class="disclaimer-button" onclick="closeDisclaimer()">确认</button>
        </div>
    </div>

    <div class="background-overlay"></div>
    <div class="container">
        <div class="header">
            <h1>绝代双骄:终焉未至 荣耀礼盒</h1>
            <div class="status-bar">
                <div>🎰 抽取次数：<span id="drawCount">0</span></div>
                <div>⭐ 荣耀值：<span id="honorValue">0</span>/300</div>
                <div>🎁 已获奖励：<span id="rewardsCounter">0</span> 个</div>
            </div>
        </div>
        
        <div class="card">
            <div id="result"></div>
            <button class="draw-button" onclick="draw()" id="drawButton">
                ✨ 消耗1000金币抽卡 ✨
            </button>
        </div>

        <div class="card">
            <h2>🛒 兑换商店</h2>
            <div class="shop-row">
                <div class="shop-item">
                    <img src="https://cdn.jsdelivr.net/gh/Kybzl/Pictures@main/images/cr7.jpg" 
                         class="player-image">
                    <h3>C罗</h3>
                    <button onclick="exchange(36, 'C罗')">36 ⭐ 兑换</button>
                </div>
                <div class="shop-item">
                    <img src="https://cdn.jsdelivr.net/gh/Kybzl/Pictures@main/images/btmessi.jpg" 
                         class="player-image">
                    <h3>梅西</h3>
                    <button onclick="exchange(36, '梅西')">36 ⭐ 兑换</button>
                </div>
                <div class="shop-item">
                    <img src="https://cdn.jsdelivr.net/gh/Kybzl/Pictures@main/images/double_team.jpg" 
                         class="player-image"></br>
                    <h3>双人组合包</h3>
                    <button onclick="exchange(63, '双人组合包')">63 ⭐ 兑换</button>
                </div>
                <div class="shop-item">
                    <img src="https://cdn.jsdelivr.net/gh/Kybzl/Pictures@main/images/cr7.jpg" 
                         class="player-image">
                    <h3>5%含C罗</h3>
                    <button onclick="exchange(2, '5%含C罗')">2 ⭐ 兑换</button>
                </div>
                <div class="shop-item">
                    <img src="https://cdn.jsdelivr.net/gh/Kybzl/Pictures@main/images/btmessi.jpg" 
                         class="player-image">
                    <h3>5%含梅西</h3>
                    <button onclick="exchange(2, '5%含梅西')">2 ⭐ 兑换</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>🎁 累计奖励</h2>
            <div class="rewards-container" id="rewardsContainer"></div>
            <button class="collapse-button" id="collapseButton" onclick="toggleCollapse()">展开更多奖励</button>
            
            <h3 style="margin-top: 30px;">📜 历史记录</h3>
            <div class="history-container" id="historyContainer">
                <div class="history-item" style="color: #FFD700; font-style: italic;">
                    暂无特殊球员记录
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <div class="footer">
        作者：大众评球@不出维埃拉不改名（已兑换）
    </div>

    <!-- 自选弹窗 -->
    <div class="selection-modal" id="selectionModal">
        <div class="selection-content">
            <h2>选择球员碎片</h2>
            <p>请从以下选项中选择一名球员碎片：</p>
            <div id="playerOptions">
                <div class="player-option" onclick="selectPlayer('C罗碎片')">
                    <img src="https://cdn.jsdelivr.net/gh/Kybzl/Pictures@main/images/cr7.jpg">
                    <span>C罗碎片</span>
                </div>
                <div class="player-option" onclick="selectPlayer('梅西碎片')">
                    <img src="https://cdn.jsdelivr.net/gh/Kybzl/Pictures@main/images/btmessi.jpg">
                    <span>梅西碎片</span>
                </div>
            </div>
            <button class="disclaimer-button" style="margin-top: 20px;" onclick="closeSelection()">取消</button>
        </div>
    </div>

    <script>
        // 在原有状态对象中添加历史记录数组
        let state = {
            drawCount: 0,
            honor: 0,
            gold: 1000000,
            claimedRewards: [],
            rewardCycles: {},
            lastRewardCycle: -1,
            history: [],  // 新增历史记录数组
            // 新增：梦幻精选箱式已抽取的球员
            dreamBoxDrawnPlayers: []
        };

        // 免责声明弹窗控制
        function closeDisclaimer() {
            document.getElementById('disclaimerModal').style.display = 'none';
        }
        
        const rewardSystem = {
            cycleLength: 25,
            rewards: [
                {
                    step: 5,
                    name: '荣耀高光礼盒',
                    players: ['史诗赫内斯','史诗古蒂','史诗野猪戴维斯','史诗切赫','单增能兰帕德','双增能巴蒂','双增能科斯塔','双增能亚当斯']
                },
                {
                    step: 10,
                    name: '梦幻精选箱式',
                    players: ['莱奥','维蒂尼亚','阿尔瓦雷斯','麦卡利斯特','门德斯']
                },
                {
                    step: 15,
                    name: '96+增能史诗',
                    players: ['卡纳瓦罗', '济科', '梅西', '克鲁伊夫', '普拉蒂尼', '埃托奥', '罗纳尔迪尼奥', '德科', '19岁长发梅西', '里杰卡尔德', '范巴斯滕', '古利特', '贝隆', '阿扎尔', '图拉姆', '比利亚', '贝克汉姆', '托蒂', '米兰小罗', '巴雷西', '舍甫琴科', '哈维', '切赫', '杰拉德', '维埃拉', '内德维德', '皮尔洛', '单增德科', '德罗巴', '欧文', '坎通纳', '马尔蒂尼', '范尼斯特鲁伊', '德尔皮耶罗', '奥运内马尔', '斯科尔斯', '利物浦杰拉德', '卡洛斯', '罗马里奥', '巴乔', '马克莱莱', '单增卡纳瓦罗', '菲戈', '卡西利亚斯', '单增比利亚', '意大利马尔蒂尼', '米兰范巴斯滕', '西班牙哈维', '单增贝隆', '捷克切赫', '贝尔', '英格兰贝克汉姆', '曼联斯科尔斯', '意大利托蒂', '巴萨罗马里奥', '意大利皮尔洛', '意大利巴乔', '意大利皮耶罗', '皇马马克莱莱', '贝尔巴托夫', '迪达', '博格坎普', '双增费雷尔', '双增兰帕德', '双增阿隆索', '双增斯内德', '亚马尔', '罗伊斯', '单增斯内德', '单增麦孔', '单增内斯塔', '单增卡洛斯', '巴蒂', '切尔西马克莱莱', '皇马卡西', '单增博格坎普', '单增古蒂', '单增科斯塔', '单增劳尔', '单增皇马小贝', '单增里瓦尔多', '单增兰帕德', '单增弗兰', '单增舒梅切尔', '单增卡福', '单增皇马斯内德', '奥兰多内斯塔', '单增克鲁伊维特', '单增费雷尔', '单增阿隆索', '单增戴维斯', '单增阿尔贝蒂尼', '单增卡卡', '单增伊涅斯塔', '单增托雷斯', '单增弗兰', '单增斯托伊科维奇', '单增劳尔', '单增因扎吉', '国米博格坎普', '英格兰兰帕德', '阿隆索', '科斯塔', '双增科斯塔库塔', '双增博扬', '双增久利', '双增内马尔', '双增安布罗西尼', '双增埃德米尔森', '朴智星', '中田英寿', '莫伦特斯', '埃尔文', '罗布森', '利物浦阿隆索', '扬科勒', '科斯塔库塔', '桑托斯马儿', '瓜迪奥拉', '单增埃德米尔森', '塞尔吉奥', '香川真司', '门迭塔', '贝尔戈mi', '斯托伊科维奇', '安布罗西尼', '德尼尔森', '贝莱蒂', '萨维奥拉', '阿德里亚诺', '巴甲罗马里奥', '弗莱彻', '多纳多尼', '切尔西托雷斯', '大卫比利亚', '双增瓜迪奥拉', '加西亚', '埃瓦尔', '米兰因扎吉', '双增拜亚']
                },
                {
                    step: 20,
                    name: '荣耀传奇礼盒',
                    players:['黄传鲁梅尼格','黄传维埃拉','黄传兰帕德','黄传里杰卡尔德','黄传劳尔','黄传弗兰','黄传埃德米尔森'],
                },
                {
                    step: 25,
                    name: '自选闪耀碎片',
                    players: ['C罗闪耀碎片','梅西闪耀碎片']
                }
            ],

            getCurrentRewards(drawCount) {
                const currentCycle = Math.floor((drawCount - 1) / this.cycleLength);
                const currentStep = drawCount % this.cycleLength || this.cycleLength;
                
                return this.rewards.filter(reward => {
                    return currentStep >= reward.step && 
                         !this.isClaimed(reward.name, currentCycle);
                });
            },

            isClaimed(rewardName, cycle) {
                return state.rewardCycles[`${rewardName}_${cycle}`] === true;
            },

            markAsClaimed(rewardName, cycle) {
                state.rewardCycles[`${rewardName}_${cycle}`] = true;
            }
        };

        function draw() {
            if (state.gold < 1000) {
                alert('金币不足！');
                return;
            }

            state.gold -= 1000;
            const currentDrawCount = ++state.drawCount;

            const baseProb = probabilityConfig.getCurrentProb(currentDrawCount);
            const rate = rateCalculator.getRate(currentDrawCount);
            const actualProb = (baseProb * rate) / 100;

            const isHonor = Math.random() * 100 < actualProb;
            if (isHonor) state.honor += 1;

            const currentRewards = rewardSystem.getCurrentRewards(state.drawCount);
            currentRewards.forEach(reward => {
                const currentCycle = Math.floor((state.drawCount - 1) / rewardSystem.cycleLength);
                rewardSystem.markAsClaimed(reward.name, currentCycle);
                
                const rewardEntry = {
                    id: Date.now() + Math.random(),
                    name: reward.name,
                    players: reward.players,
                    cycle: currentCycle,
                    claimTime: new Date().toLocaleString(),
                    opened: false
                };

                state.claimedRewards.push(rewardEntry);
                showRewardNotification(rewardEntry);
            });

            updateUI(isHonor ? '🎉 荣耀降临！获得1点荣耀值' : `🏆 获得球员：${getRandomPlayer()}`, 
                   isHonor ? '#FFD700' : '#00FF88');
        }

        // 修改兑换函数，添加历史记录
        function exchange(cost, item) {
            if (state.honor >= cost) {
                state.honor -= cost;
                
                // 处理5%兑换选项
                if (item === '5%含C罗' || item === '5%含梅西') {
                    const targetPlayer = item === '5%含C罗' ? 'C罗' : '梅西';
                    
                    // 创建140人的奖池
                    const pool = createFivePercentPool(targetPlayer);
                    
                    const rewardEntry = {
                        id: Date.now() + Math.random(),
                        name: item,
                        players: pool,
                        targetPlayer: targetPlayer,
                        claimTime: new Date().toLocaleString(),
                        opened: false,
                        type: 'fivePercent'
                    };

                    state.claimedRewards.push(rewardEntry);
                    alert('兑换成功！获得：' + item);
                    updateUI();
                    return;
                }
                
                // 添加到历史记录
                addToHistory(item, 'exchange');
                
                alert('兑换成功！获得：' + item);
                updateUI();
            } else {
                alert('荣耀值不足！');
            }
        }
        
        // 创建5%奖池
        function createFivePercentPool(targetPlayer) {
            const pool = [];
            
            // 添加目标球员（5%概率）
            for (let i = 0; i < 7; i++) {
                pool.push(targetPlayer);
            }
            
            // 添加其他球员（95%概率）
            const normalPlayers = getNormalPlayers(133);
            pool.push(...normalPlayers);
            
            // 打乱奖池
            return shuffleArray(pool);
        }
        
        // 获取普通球员
        function getNormalPlayers(count) {
            const allPlayers = NORMAL_PLAYERS;
            const shuffled = [...allPlayers].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }
        
        // 打乱数组
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // 修改开启奖励函数，处理自选闪耀碎片和5%奖池
        function openReward(rewardId) {
            const reward = state.claimedRewards.find(r => r.id === rewardId);
            if (!reward || reward.opened) return;
            
            // 特殊处理自选闪耀碎片
            if (reward.name === '自选闪耀碎片') {
                document.getElementById('selectionModal').style.display = 'flex';
                // 保存当前奖励ID以便选择后使用
                window.currentRewardId = rewardId;
                return;
            }
            
            // 处理5%奖池
            if (reward.type === 'fivePercent') {
                const player = reward.players[Math.floor(Math.random() * reward.players.length)];
                
                // 检查是否抽中目标球员
                if (player === reward.targetPlayer) {
                    alert(`🎉 天选之人！你抽中了：${player}`);
                    // 添加到历史记录
                    addToHistory(player, 'reward');
                } else {
                    alert(`🎉 开启成功！获得球员：${player}`);
                    // 普通球员不记录历史
                }
                
                reward.opened = true;
                updateUI();
                return;
            }
            
            // 处理梦幻精选箱式（抽出不放回）
            if (reward.name === '梦幻精选箱式') {
                // 获取未抽取的球员
                const availablePlayers = reward.players.filter(p => 
                    !state.dreamBoxDrawnPlayers.includes(p)
                );
                
                if (availablePlayers.length === 0) {
                    alert('该箱式中的所有球员都已抽取完毕！');
                    return;
                }
                
                // 随机选择一个球员
                const player = availablePlayers[Math.floor(Math.random() * availablePlayers.length)];
                
                // 标记该球员为已抽取
                state.dreamBoxDrawnPlayers.push(player);
                
                alert(`🎉 开启成功！获得球员：${player}`);
                reward.opened = true;
                
                // 添加到历史记录
                addToHistory(player, 'reward');
                
                updateUI();
                return;
            }
            
            // 普通奖励正常随机选择
            const player = reward.players[Math.floor(Math.random() * reward.players.length)];
            alert(`🎉 开启成功！获得球员：${player}`);
            
            reward.opened = true;
            
            // 添加到历史记录
            addToHistory(player, 'reward');
            
            updateUI();
        }
        
        // 自选球员功能
        function selectPlayer(player) {
            const rewardId = window.currentRewardId;
            const reward = state.claimedRewards.find(r => r.id === rewardId);
            
            if (reward) {
                alert(`🎉 开启成功！获得球员碎片：${player}`);
                reward.opened = true;
                
                // 添加到历史记录
                addToHistory(player, 'reward');
                
                updateUI();
            }
            
            closeSelection();
        }
        
        function closeSelection() {
            document.getElementById('selectionModal').style.display = 'none';
        }
        
        // 添加到历史记录函数
        function addToHistory(player, type) {
            const historyItem = {
                player: player,
                type: type,
                time: new Date().toLocaleString()
            };
            
            state.history.unshift(historyItem);
            updateHistoryDisplay();
        }
        
        // 更新历史记录显示
        function updateHistoryDisplay() {
            const container = document.getElementById('historyContainer');
            
            if (state.history.length === 0) {
                container.innerHTML = '<div class="history-item" style="color: #FFD700; font-style: italic;">暂无特殊球员记录</div>';
                return;
            }
            
            container.innerHTML = state.history.map(item => `
                <div class="history-item">
                    <div>${item.type === 'exchange' ? '🛒 兑换' : '🎁 获得'}：<span class="history-player">${item.player}</span></div>
                    <div style="font-size: 0.8em; opacity: 0.7;">${item.time}</div>
                </div>
            `).join('');
        }
        
        // 在updateUI函数中调用更新历史记录
        function updateUI(message, color) {
            document.getElementById('drawCount').textContent = state.drawCount;
            document.getElementById('honorValue').textContent = state.honor;
            document.getElementById('rewardsCounter').textContent = state.claimedRewards.length;

            if (message) showResult(message, color);
            updateRewardsDisplay();
            updateHistoryDisplay();
            document.getElementById('drawButton').disabled = state.gold < 1000;
        }
        
        function updateRewardsDisplay() {
            const container = document.getElementById('rewardsContainer');
            container.innerHTML = state.claimedRewards.map(reward => `
                <div class="reward-item">
                    <h3>${reward.name} ${reward.type === 'fivePercent' ? '<span class="reward-badge">5%奖池</span>' : ''}</h3>
                    ${reward.opened ? 
                        '<p>🎁 已开启</p>' : 
                        `<button class="open-button" onclick="openReward(${reward.id})">
                            ✨ 打开礼包 ✨
                        </button>`
                    }
                </div>
            `).join('');

            const collapseButton = document.getElementById('collapseButton');
            collapseButton.style.display = state.claimedRewards.length > 2 ? 'block' : 'none';
        }

        const probabilityConfig = {
            phases: [
                { start: 0,  prob: 3   },
                { start: 5,  prob: 3.75},
                { start: 10, prob: 4.5 },  
                { start: 15, prob: 5.25},
                { start: 20, prob: 5.88},
                { start: 25, prob: 6   }
            ],
            getCurrentProb(count) {
                const phase = this.phases.slice().reverse().find(p => count >= p.start);
                return phase ? phase.prob : 0;
            }
        };

        const rateCalculator = {
            getRate(count) {
                if (count <= 5) return 100 + (count - 1) * 100;
                return Math.min(475 + (count - 5) * 25, 1000);
            }
        }; 

        function showResult(message, color) {
            const currentStep = state.drawCount % rewardSystem.cycleLength || rewardSystem.cycleLength;
            document.getElementById('result').innerHTML = `
                <div style="border: 2px solid ${color}; border-radius: 10px; padding: 15px; margin: 15px 0;">
                    <h3 style="color: ${color}; margin: 0;">${message}</h3>
                    <small>当前概率：${probabilityConfig.getCurrentProb(state.drawCount)}%</small> <br>
                    <small>当前倍率：${rateCalculator.getRate(state.drawCount)}%</small>
                </div>`;
        }

        function showRewardNotification(rewardEntry) {
            const notification = document.createElement('div');
            notification.style = "border: 2px solid #00FF88; border-radius: 10px; padding: 15px; margin: 10px 0;";
            notification.innerHTML = `
                <h3 style="color: #00FF88; margin: 0;">🎁 获得累计奖励：${rewardEntry.name}</h3>
            `;
            document.getElementById('result').prepend(notification);
        }

        // 提取普通球员列表到全局常量
        const NORMAL_PLAYERS = ['孙兴慜', '哈里·凯恩', '德布劳内', '萨拉赫', '范戴克',
            '布鲁诺·费尔南德斯', '坎特', '斯特林', '阿诺德', '马内',
            '拉什福德', '桑乔', '福登', '格拉利什', '詹姆斯',
            '蒂亚戈', '若日尼奥', '芒特', '卢卡库', '齐耶赫',
            '吕迪格', '阿斯皮利奎塔', '热苏斯', '津琴科', '洛里',
            '凯尔·沃克', '马赫雷斯', '京多安', '罗德里', '埃德森', '迪亚斯', '贝尔纳多·席尔瓦', '菲尔·福登', '卡塞米罗', '瓦拉内',            
            '桑切斯', '厄德高', '萨卡', '奥巴梅扬', '拉卡泽特',
            '托马斯·帕尔特伊', '本·怀特', '蒂尔尼', '史密斯·罗', '洛孔加',
            '富安健洋', '马丁内利', '恩凯蒂亚', '拉姆斯代尔', '霍尔丁',
            '本泽马', '莫德里奇', '维尼修斯', '库尔图瓦', '阿拉巴',
            '克罗斯', '巴尔韦德', '罗德里戈', '阿森西奥', '卡马文加',
            '米利唐', '吕迪格', '纳乔', '卡瓦哈尔', '巴斯克斯',
            '梅西', '莱万多夫斯基', '佩德里', '加维', '德容',
            '特尔施特根', '阿劳霍', '克里斯滕森', '孔德', '登贝莱',
            '费兰·托雷斯', '拉菲尼亚', '凯西', '布斯克茨', '阿尔巴',
            '格里兹曼', '莫拉ta', '科克', '萨乌尔', '略伦特',
            '奥布拉克', '希门尼斯', '勒马尔', '卡拉斯科', '德保罗',
            '费利克斯', '格列兹曼', '苏亚雷斯', '卡瓦尼', '皮克',
            '阿尔维斯', '普伊格', '尼科', '加西亚', '法蒂',
            '穆勒', '基米希', '诺伊尔', '萨内', '格纳布里',
            '戴维斯', '卢卡斯·埃尔南德斯', '帕瓦尔', '格雷茨卡', '马内',
            '德里赫特', '坎塞洛', '科曼', '索默', '于帕梅卡诺',
            '哈兰德', '贝林厄姆', '罗伊斯', '布兰特', '阿坎吉',
            '胡梅尔斯', '穆科科', '雷纳', '施洛特贝克', '聚勒',
            '维尔茨', '迪亚比', '塔普索巴', '弗林蓬', '赫洛热克',
            '恩昆库', '奥尔莫', '维尔纳', '劳姆', '克洛斯特曼',
            '莱默尔', '西马坎', '亨里希斯', '波尔森', '福斯贝里',
            '索博斯洛伊', '格瓦迪奥尔', '莱比锡', '恩梅查', '阿德耶米',
            '马伦', '施洛特贝克', '沃尔夫', '雷纳', '贝克尔',
            '莱奥', '吉鲁', '特奥', '托纳利', '迈尼昂',
            '迪亚斯', '卡拉布里亚', '克亚尔', '本纳赛尔', '萨勒马克尔斯',
            '劳塔罗', '巴雷拉', '什克里尼亚尔', '巴斯托尼', '恰尔汗奥卢',
            '卢卡库', '哲科', '邓弗里斯', '德弗里', '布罗佐维奇',
            '奥斯梅恩', '克瓦拉茨赫利亚', '金玟哉', '洛博特', '安古伊萨',
            '迪洛伦佐', '鲁伊', '梅雷特', '波利塔诺', '泽林斯基',
            '弗拉霍维奇', '基耶萨', '博格巴', '达尼洛', '布雷默',
            '迪马利亚', '帕雷德斯', '科斯蒂奇', '米利克', '洛卡特利',
            '因莫比莱', '阿尔贝托', '米林科维奇', '安德森', '扎卡尼',
            '罗马尼奥利', '托莫里', '卡卢卢', '克鲁尼奇', '雷比奇',
            '姆巴佩', '内马尔', '梅西', '多纳鲁马', '拉莫斯',
            '马尔基尼奥斯', '维拉蒂', '阿什拉夫', '门德斯', '金彭贝',
            '埃基蒂克', '桑谢斯', '鲁伊斯', '索莱尔', '穆基勒',
            '大卫', '乔纳森·戴维', '丰特', '热尔松', '安德烈·戈麦斯',
            '卡贝拉', '班巴', '奥纳斯', '尼古拉斯·佩佩', '迪亚基特',
            '福法纳', '古斯托', '拉卡泽特', '托利索', '帕奎塔',
            '登贝莱', '巴尔科拉', '切尔基', '奥亚尔', '帕瓦尔',
            '泰里耶', '萨瓦尼耶', '马维迪迪', '埃梅加', '瓦希',
            '卡马拉', '克劳斯', '桑通兹', '阿塔尔', '布巴卡尔·卡马拉',
            '云代尔', '帕耶', '贡多齐', '路易斯·苏亚雷斯', '巴洛贡'];

        function getRandomPlayer() {
            return NORMAL_PLAYERS[Math.floor(Math.random() * NORMAL_PLAYERS.length)];
        }

        let isCollapsed = true;
        function toggleCollapse() {
            const container = document.getElementById('rewardsContainer');
            container.classList.toggle('collapsed');
            document.getElementById('collapseButton').textContent = 
                container.classList.contains('collapsed') ? '展开更多奖励' : '收起奖励';
        }

        // 初始化
        updateUI();
    </script>
</body>
</html>
